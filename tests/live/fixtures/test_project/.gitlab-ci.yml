stages:
  - test
  - build
  - deploy

variables:
  PYTHON_VERSION: "3.11"

.python:
  image: python:${PYTHON_VERSION}
  before_script:
    - pip install -e ".[dev]"

test:
  extends: .python
  stage: test
  script:
    - pytest tests/ -v --cov=src --cov-report=xml
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

lint:
  extends: .python
  stage: test
  script:
    - flake8 src/
    - mypy src/

build:
  extends: .python
  stage: build
  script:
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

deploy:
  stage: deploy
  script:
    - echo "Deploying..."
  only:
    - main
  when: manual
